{"version":3,"sources":["talkApp/js/talkApp.js"],"names":["vm","Vue","el","data","currentGroup","msgRecognizing","msgRecording","autoSend","tempMsg","text","audioBlob","audioUrl","audioDuration","groups","id","title","messages","watch","audio","Audio","play","computed","reverse","methods","recordFn","mediaRecorder","start","navigator","mediaDevices","getUserMedia","then","stream","MediaRecorder","startTime","Date","now","audioChunks","addEventListener","event","push","stopTime","Blob","URL","createObjectURL","sendMsg","end","stop","inputRecognition","SpeechRecognition","webkitSpeechRecognition","SpeechGrammarList","webkitSpeechGrammarList","SpeechRecognitionEvent","webkitSpeechRecognitionEvent","recognition","continuous","interimResults","lang","record","onstart","onend","commandRecognition","onresult","interim_transcript","final_transcript","i","resultIndex","results","length","isFinal","transcript","commands","grammar","join","speechRecognitionList","addFromString","grammars","maxAlternatives","console","log","setTimeout","last","command","toLowerCase","confidence","includes","switchGroup","group","inputGroup","replace","trim","index","parseInt","find","item","e","msg","timestamp","created","filters","timeFormat","date","year","getFullYear","month","getMonth","day","getDate","hours","getHours","minutes","getMinutes","seconds","getSeconds","substr"],"mappings":"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","sourcesContent":["var vm;\nvm = new Vue({\n  el: '#app',\n  data: {\n    currentGroup: {},\n    msgRecognizing: false,\n    msgRecording: false,\n    autoSend: false,\n    tempMsg: {\n      text: null,\n      audioBlob: null,\n      audioUrl: null,\n      audioDuration: null\n    },\n    groups: [\n      { id: '#1', title: '101 Airborne Division', messages: [] },\n      { id: '#2', title: 'Easy Company', messages: [] }\n    ]\n  },\n  watch: {\n    currentGroup() {\n      const audio = new Audio('./sound/channel.mp3');\n      audio.play();\n    }\n  },\n  computed: {\n    messages() {\n      return this.currentGroup.messages.reverse();\n    }\n  },\n  methods: {\n    recordFn() {\n      return {\n        mediaRecorder: null,\n        start: function () {\n          vm.msgRecording = true;\n          navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {\n            this.mediaRecorder = new MediaRecorder(stream);\n            this.mediaRecorder.start();\n            const startTime = Date.now();\n            const audioChunks = [];\n            this.mediaRecorder.addEventListener('dataavailable', event => {\n              audioChunks.push(event.data);\n            });\n            this.mediaRecorder.addEventListener('stop', () => {\n              const stopTime = Date.now();\n              vm.tempMsg.audioDuration = stopTime - startTime;\n              const audioBlob = new Blob(audioChunks);\n              const audioUrl = URL.createObjectURL(audioBlob);\n              vm.tempMsg.audioBlob = audioBlob;\n              vm.tempMsg.audioUrl = audioUrl;\n              if (vm.autoSend) {\n                vm.sendMsg();\n              }\n            });\n          });\n        },\n        end: function () {\n          this.mediaRecorder.stop();\n          vm.msgRecording = false;\n        }\n      };\n    },\n    inputRecognition() {\n      const vm = this;\n      //辨識初始設定\n      const SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;\n      const SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;\n      const SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent;\n      const recognition = new SpeechRecognition();\n      recognition.continuous = true; // 連續辨識\n      recognition.interimResults = true; // 是否要輸出中間結果\n      recognition.lang = 'en-US';\n      //錄音初始設定\n      const record = this.recordFn();\n      // 開始辨識及錄音\n      recognition.start();\n      recognition.onstart = function () {\n        record.start();\n        vm.msgRecognizing = true; // 設定為辨識中\n      };\n      recognition.onend = function () {\n        // 辨識完成\n        record.end();\n        vm.commandRecognition();\n        vm.msgRecognizing = false; // 設定為「非辨識中」\n      };\n      recognition.onresult = function (event) {\n        let interim_transcript = ''; // 中間結果\n        let final_transcript = '';\n        for (let i = event.resultIndex; i < event.results.length; ++i) {\n          // 對於每一個辨識結果\n          if (event.results[i].isFinal) {\n            // 如果是最終結果\n            final_transcript += event.results[i][0].transcript; // 將其加入最終結果中\n            vm.tempMsg.text = final_transcript;\n            recognition.stop();\n          } else {\n            // 否則\n            interim_transcript += event.results[i][0].transcript; // 將其加入中間結果中\n            vm.tempMsg.text = interim_transcript;\n          }\n        }\n      };\n    },\n    commandRecognition() {\n      const vm = this;\n      const SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;\n      const SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;\n      const SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent;\n      const commands = ['switch to'];\n      var grammar =\n        '#JSGF V1.0; grammar commands; public <commands> = ' + commands.join(' | ') + ' ;';\n      const recognition = new SpeechRecognition();\n      const speechRecognitionList = new SpeechGrammarList();\n      speechRecognitionList.addFromString(grammar, 1);\n      recognition.grammars = speechRecognitionList;\n      recognition.lang = 'en-US';\n      recognition.continuous = true; // 連續辨識\n      recognition.interimResults = false; // 是否要輸出中間結果\n      recognition.maxAlternatives = 1;\n      recognition.start();\n      recognition.onend = function () {\n        console.log('commandRecognition End');\n        setTimeout(() => {\n          if (!vm.msgRecording) {\n            console.log('commandRecognition');\n            vm.commandRecognition();\n          }\n        }, 50);\n      };\n      recognition.onresult = function (event) {\n        //不在錄音的情況下執行\n        if (!vm.msgRecognizing) {\n          const last = event.results.length - 1;\n          const command = event.results[last][0].transcript;\n          console.log(command.toLowerCase() + ' Confidence: ' + event.results[0][0].confidence);\n          if (command.toLowerCase().includes('switch to')) {\n            switchGroup(command.toLowerCase());\n          }\n        }\n      };\n      function switchGroup(command) {\n        let group;\n        if (command.includes('channel')) {\n          const inputGroup = command.replace('switch to channel', '').trim();\n          const index = parseInt(inputGroup, 10) - 1;\n          group = vm.groups[index];\n        } else {\n          const inputGroup = command.replace('switch to', '').trim();\n          if (inputGroup == vm.currentGroup.title) return;\n          group = vm.groups.find(item => item.title.toLowerCase() == inputGroup);\n        }\n        if (group && vm.currentGroup !== group) {\n          vm.currentGroup = group;\n        }\n      }\n    },\n    sendMsg(e, msg = this.tempMsg) {\n      if (!msg.text.length && !msg.audioUrl) return;\n      msg.timestamp = Date.now();\n      this.currentGroup.messages.push(msg);\n      this.tempMsg = {\n        text: null,\n        audioBlob: null,\n        audioUrl: null,\n        audioDuration: null\n      };\n    }\n  },\n  created() {\n    this.currentGroup = this.groups[0];\n    this.commandRecognition();\n  },\n  filters: {\n    timeFormat(timestamp) {\n      let date = new Date(timestamp);\n      let year = date.getFullYear();\n      let month = date.getMonth() + 1;\n      let day = date.getDate();\n      let hours = '0' + date.getHours();\n      let minutes = '0' + date.getMinutes();\n      let seconds = '0' + date.getSeconds();\n      return `${year}-${month}-${day} ${hours.substr(-2)}:${minutes.substr(-2)}:${seconds.substr(\n        -2\n      )}`;\n    }\n  }\n});\n"],"file":"talkApp.js"}